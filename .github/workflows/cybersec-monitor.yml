name: Cybersecurity News Monitor (Scheduled)

on:
  schedule:
    - cron: '0 */12 * * *'  # Runs every 12 hours
  workflow_dispatch:

jobs:
  fetch-news:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}
      cancel-in-progress: true
    
    permissions:
      contents: write
    
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@5c7944e73c4c2a096b17a9cb74d65b6c2bbafbde # v2.9.1
        with:
          egress-policy: audit
          allowed-endpoints: >
            github.com:443
            api.github.com:443
            pypi.org:443
            files.pythonhosted.org:443
            feeds.feedburner.com:443
            www.darkreading.com:443
            krebsonsecurity.com:443
            www.schneier.com:443
            threatpost.com:443
      
      - name: Checkout repository
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true
      
      - name: Set up Python
        uses: actions/setup-python@39cd14951b08e74b54015e9e001cdefcf80e669f # v5.1.1
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: '**/requirements*.txt'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Fetch cybersecurity news
        run: python scripts/parse_cybersec_feeds.py
      
      - name: Commit and push updates
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Configure git user
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # Configure git to use token for authentication
          git config --global url."https://x-access-token:${GITHUB_TOKEN}@github.com/".insteadOf "https://github.com/"
          
          # Pull latest changes to avoid conflicts
          git pull --rebase origin main || true
          
          # Add all changes
          git add -A
          
          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "‚ö†Ô∏è No changes to commit"
            exit 0
          fi
          
          # Commit changes
          git commit -m "üì∞ Update cybersecurity news - $(date +'%Y-%m-%d %H:%M:%S UTC')"
          
          # Push with retry logic
          for i in {1..3}; do
            if git push origin HEAD:main; then
              echo "‚úÖ Successfully pushed changes!"
              exit 0
            else
              echo "‚ö†Ô∏è Push attempt $i failed, retrying..."
              git pull --rebase origin main
              sleep 2
            fi
          done
          
          echo "‚ùå Failed to push after 3 attempts"
          exit 1
      
      - name: Notify on failure
        if: failure()
        run: |
          echo "::error::Workflow failed during cybersecurity news update"
          echo "::error::Check logs above for details"
