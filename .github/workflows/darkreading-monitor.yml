name: Dark Reading Monitor

on:
  schedule:
    - cron: '30 */8 * * *'  # Runs every 8 hours at :30
  workflow_dispatch:

jobs:
  fetch-darkreading:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}
      cancel-in-progress: true
    
    permissions:
      contents: write
    
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@5c7944e73c4c2a096b17a9cb74d65b6c2bbafbde # v2.9.1
        with:
          egress-policy: audit
          allowed-endpoints: >
            github.com:443
            api.github.com:443
            pypi.org:443
            files.pythonhosted.org:443
            www.darkreading.com:443
            feeds.feedburner.com:443
      
      - name: Checkout repository
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
        with:
          persist-credentials: true
      
      - name: Set up Python
        uses: actions/setup-python@39cd14951b08e74b54015e9e001cdefcf80e669f # v5.1.1
        with:
          python-version: '3.11'
      
      - name: Verify requirements.txt
        run: |
          echo "=== Contents of requirements.txt ==="
          cat requirements.txt
          echo "==================================="
      
      - name: Install dependencies
        run: |
          echo "Upgrading pip..."
          python -m pip install --upgrade pip
          echo "Installing from requirements.txt..."
          pip install --no-cache-dir -v -r requirements.txt
          echo "Verifying feedparser installation..."
          pip list | grep -i feedparser || echo "feedparser NOT found!"
          python -c "import feedparser; print(f'feedparser version: {feedparser.__version__}')" || echo "Cannot import feedparser!"
      
      - name: Fetch Dark Reading articles
        run: python scripts/parse_cybersec_feeds.py
      
      - name: Commit and push updates
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add cybersecurity_updates/ CYBERSECURITY_NEWS.md
          git diff --quiet && git diff --staged --quiet || (git commit -m "Update cybersecurity news - $(date +'%Y-%m-%d %H:%M:%S')" && git push)
