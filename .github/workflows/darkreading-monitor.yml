name: Dark Reading & Multi-Source Security Monitor

on:
  schedule:
    # Runs every 3 hours for breaking security news
    - cron: '0 */3 * * *'
  workflow_dispatch: # Manual trigger
  inputs:
    sources:
      description: 'Specific sources to monitor (comma-separated)'
      required: false
      default: 'all'

jobs:
  monitor-security-sources:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install feedparser requests beautifulsoup4 python-dateutil lxml

      - name: Fetch Dark Reading & Multi-Source News
        run: |
          echo "Starting cybersecurity news aggregation..."
          echo "Monitoring: Dark Reading, The Hacker News, Bleeping Computer, Krebs, and 10+ sources"
          python scripts/parse_cybersec_feeds.py
        env:
          PYTHONUNBUFFERED: 1

      - name: Generate Summary Report
        run: |
          echo "Generating summary statistics..."
          if [ -f cybersecurity_updates/recent_news.json ]; then
            python3 << 'EOF'
import json
from pathlib import Path
with open('cybersecurity_updates/recent_news.json') as f:
    articles = json.load(f)
print(f'\nSummary:')
print(f'Total Recent Articles: {len(articles)}')
sources = {}
for article in articles:
    src = article.get('source', 'Unknown')
    sources[src] = sources.get(src, 0) + 1
print(f'\nArticles by Source:')
for src, count in sorted(sources.items(), key=lambda x: x[1], reverse=True):
    print(f' - {src}: {count}')
severities = {}
for article in articles:
    sev = article.get('analysis', {}).get('severity', 'Unknown')
    severities[sev] = severities.get(sev, 0) + 1
print(f'\nArticles by Severity:')
for sev in ['Critical', 'High', 'Medium', 'Low', 'Unknown']:
    count = severities.get(sev, 0)
    if count > 0:
        print(f' - {sev}: {count}')
total_cves = 0
for article in articles:
    cves = article.get('analysis', {}).get('cves', [])
    total_cves += len(cves)
print(f'\nTotal CVEs Tracked: {total_cves}')
EOF
          fi

      - name: Check for Critical Alerts
        id: critical_check
        run: |
          if [ -f cybersecurity_updates/recent_news.json ]; then
            CRITICAL_COUNT=$(python3 << 'EOF'
import json
with open('cybersecurity_updates/recent_news.json') as f:
    articles = json.load(f)
critical = sum(1 for a in articles if a.get('analysis', {}).get('severity') == 'Critical')
print(critical)
EOF
)
            echo "critical_count=$CRITICAL_COUNT" >> $GITHUB_OUTPUT
            
            if [ "$CRITICAL_COUNT" -gt 0 ]; then
              echo "ALERT: $CRITICAL_COUNT critical security issues detected!"
            fi
          fi

      - name: Create Issue for Critical Alerts
        if: steps.critical_check.outputs.critical_count > 0
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const articles = JSON.parse(fs.readFileSync('cybersecurity_updates/recent_news.json', 'utf8'));
            
            const critical = articles.filter(a => a.analysis?.severity === 'Critical');
            
            if (critical.length === 0) return;
            
            let body = `## ðŸš¨ Critical Security Alerts Detected\n\n`;
            body += `**Date:** ${new Date().toISOString().split('T')[0]}\n`;
            body += `**Critical Issues:** ${critical.length}\n\n`;
            body += `---\n\n`;
            
            critical.slice(0, 5).forEach((article, idx) => {
              body += `### ${idx + 1}. ${article.title}\n\n`;
              body += `- **Source:** ${article.source}\n`;
              body += `- **Published:** ${article.published}\n`;
              body += `- **Link:** ${article.link}\n`;
              
              if (article.analysis?.cves?.length > 0) {
                body += `- **CVEs:** ${article.analysis.cves.join(', ')}\n`;
              }
              
              if (article.ai_summary) {
                body += `\n${article.ai_summary}\n`;
              }
              
              body += `\n---\n\n`;
            });
            
            const title = `ðŸš¨ Critical Security Alert: ${critical.length} Issues Detected - ${new Date().toISOString().split('T')[0]}`;
            
            const today = new Date().toISOString().split('T')[0];
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.owner,
              state: 'open',
              labels: 'critical-alert',
              per_page: 10
            });
            
            const existsToday = issues.some(i => i.title.includes(today));
            
            if (!existsToday) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['critical-alert', 'security', 'automated']
              });
            }

      - name: Commit and push updates
        run: |
          git config --global user.name 'Dark Reading Monitor Bot'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add -A
          git diff --quiet && git diff --staged --quiet || (
            git pull origin main --rebase &&
            git commit -m "Security Update: Dark Reading & Multi-Source Monitor - $(date +'%Y-%m-%d %H:%M:%S')" &&
            git push
          )

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: cybersecurity-reports-${{ github.run_number }}
          path: |
            cybersecurity_updates/*.json
            CYBERSECURITY_NEWS.md
          retention-days: 30

      - name: Workflow Summary
        if: always()
        run: |
          echo "## Cybersecurity Monitoring Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow:** Dark Reading & Multi-Source Monitor" >> $GITHUB_STEP_SUMMARY
          echo "**Run Time:** $(date +'%Y-%m-%d %H:%M:%S IST')" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f cybersecurity_updates/recent_news.json ]; then
            ARTICLE_COUNT=$(python3 -c "import json; print(len(json.load(open('cybersecurity_updates/recent_news.json'))))")
            echo "**Articles Processed:** $ARTICLE_COUNT" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Sources Monitored" >> $GITHUB_STEP_SUMMARY
            echo "- Dark Reading" >> $GITHUB_STEP_SUMMARY
            echo "- The Hacker News" >> $GITHUB_STEP_SUMMARY
            echo "- Bleeping Computer" >> $GITHUB_STEP_SUMMARY
            echo "- Krebs on Security" >> $GITHUB_STEP_SUMMARY
            echo "- SecurityWeek" >> $GITHUB_STEP_SUMMARY
            echo "- Cisco Talos Blog" >> $GITHUB_STEP_SUMMARY
            echo "- Recorded Future" >> $GITHUB_STEP_SUMMARY
            echo "- ThreatPost" >> $GITHUB_STEP_SUMMARY
            echo "- Sophos News" >> $GITHUB_STEP_SUMMARY
            echo "- Malwarebytes Blog" >> $GITHUB_STEP_SUMMARY
            echo "- CrowdStrike Blog" >> $GITHUB_STEP_SUMMARY
            echo "- CISA Alerts" >> $GITHUB_STEP_SUMMARY
            echo "- US-CERT" >> $GITHUB_STEP_SUMMARY
            echo "- Cloud Security Alliance" >> $GITHUB_STEP_SUMMARY
            echo "- SANS Reading Room" >> $GITHUB_STEP_SUMMARY
          fi
